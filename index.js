!function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=8)}([function(t,e){var r="undefined"!=typeof ArrayBuffer,n="undefined"!=typeof Symbol;function i(t,e){var i,o,s,a,h;if(!t)throw new Error("obliterator/forEach: invalid iterable.");if("function"!=typeof e)throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(t)||r&&ArrayBuffer.isView(t)||"string"==typeof t||"[object Arguments]"===t.toString())for(s=0,a=t.length;s<a;s++)e(t[s],s);else if("function"!=typeof t.forEach)if(n&&Symbol.iterator in t&&"function"!=typeof t.next&&(t=t[Symbol.iterator]()),"function"!=typeof t.next)for(o in t)t.hasOwnProperty(o)&&e(t[o],o);else for(i=t,s=0;!0!==(h=i.next()).done;)e(h.value,s),s++;else t.forEach(e)}i.forEachWithNullKeys=function(t,e){var i,o,s,a,h;if(!t)throw new Error("obliterator/forEachWithNullKeys: invalid iterable.");if("function"!=typeof e)throw new Error("obliterator/forEachWithNullKeys: expecting a callback.");if(Array.isArray(t)||r&&ArrayBuffer.isView(t)||"string"==typeof t||"[object Arguments]"===t.toString())for(s=0,a=t.length;s<a;s++)e(t[s],null);else if(t instanceof Set)t.forEach((function(t){e(t,null)}));else if("function"!=typeof t.forEach)if(n&&Symbol.iterator in t&&"function"!=typeof t.next&&(t=t[Symbol.iterator]()),"function"!=typeof t.next)for(o in t)t.hasOwnProperty(o)&&e(t[o],o);else for(i=t,s=0;!0!==(h=i.next()).done;)e(h.value,null),s++;else t.forEach(e)},t.exports=i},function(t,e){e.DEFAULT_COMPARATOR=function(t,e){return t<e?-1:t>e?1:0},e.DEFAULT_REVERSE_COMPARATOR=function(t,e){return t<e?1:t>e?-1:0},e.reverseComparator=function(t){return function(e,r){return t(r,e)}},e.createTupleComparator=function(t){return 2===t?function(t,e){return t[0]<e[0]?-1:t[0]>e[0]?1:t[1]<e[1]?-1:t[1]>e[1]?1:0}:function(e,r){for(var n=0;n<t;){if(e[n]<r[n])return-1;if(e[n]>r[n])return 1;n++}return 0}}},function(t,e,r){var n=r(3),i=r(0),o=r(4),s=function(t,e){return t[1]>e[1]?-1:t[1]<e[1]?1:0};function a(){this.items=new Map,Object.defineProperty(this.items,"constructor",{value:a,enumerable:!1}),this.clear()}a.prototype.clear=function(){this.size=0,this.dimension=0,this.items.clear()},a.prototype.add=function(t,e){if(0===e)return this;if(e<0)return this.remove(t,-e);if("number"!=typeof(e=e||1))throw new Error("mnemonist/multi-set.add: given count should be a number.");this.size+=e;const r=this.items.get(t);return void 0===r?this.dimension++:e+=r,this.items.set(t,e),this},a.prototype.set=function(t,e){var r;if("number"!=typeof e)throw new Error("mnemonist/multi-set.set: given count should be a number.");return e<=0?(void 0!==(r=this.items.get(t))&&(this.size-=r,this.dimension--),this.items.delete(t),this):(e=e||1,"number"==typeof(r=this.items.get(t))?this.items.set(t,r+e):(this.dimension++,this.items.set(t,e)),this.size+=e,this)},a.prototype.has=function(t){return this.items.has(t)},a.prototype.delete=function(t){var e=this.items.get(t);return 0!==e&&(this.size-=e,this.dimension--,this.items.delete(t),!0)},a.prototype.remove=function(t,e){if(0!==e){if(e<0)return this.add(t,-e);if("number"!=typeof(e=e||1))throw new Error("mnemonist/multi-set.remove: given count should be a number.");var r=this.multiplicity(t),n=Math.max(0,r-e);0===n?this.delete(t):(this.items.set(t,n),this.size-=r-n)}},a.prototype.edit=function(t,e){var r=this.multiplicity(t);if(0!==r){var n=this.multiplicity(e);return this.items.set(e,r+n),this.items.delete(t),this}},a.prototype.multiplicity=function(t){var e=this.items.get(t);return void 0===e?0:e},a.prototype.get=a.prototype.multiplicity,a.prototype.count=a.prototype.multiplicity,a.prototype.frequency=function(t){return 0===this.size?0:this.multiplicity(t)/this.size},a.prototype.top=function(t){if("number"!=typeof t||t<=0)throw new Error("mnemonist/multi-set.top: n must be a number > 0.");for(var e,r=new o(Array,s,t),n=this.items.entries();!(e=n.next()).done;)r.push(e.value);return r.consume()},a.prototype.forEach=function(t,e){var r;e=arguments.length>1?e:this,this.items.forEach((function(n,i){for(r=0;r<n;r++)t.call(e,i,i)}))},a.prototype.forEachMultiplicity=function(t,e){e=arguments.length>1?e:this,this.items.forEach(t,e)},a.prototype.keys=function(){return this.items.keys()},a.prototype.values=function(){var t,e,r,i,o=this.items.entries(),s=!1;return new n((function n(){if(!s){if((t=o.next()).done)return{done:!0};s=!0,e=t.value[0],r=t.value[1],i=0}return i>=r?(s=!1,n()):(i++,{done:!1,value:e})}))},a.prototype.multiplicities=function(){return this.items.entries()},"undefined"!=typeof Symbol&&(a.prototype[Symbol.iterator]=a.prototype.values),a.prototype.inspect=function(){return this.items},"undefined"!=typeof Symbol&&(a.prototype[Symbol.for("nodejs.util.inspect.custom")]=a.prototype.inspect),a.prototype.toJSON=function(){return this.items},a.from=function(t){var e=new a;return i(t,(function(t){e.add(t)})),e},a.isSubset=function(t,e){var r,n,i,o=t.multiplicities();if(t===e)return!0;if(t.dimension>e.dimension)return!1;for(;!(r=o.next()).done;)if(n=r.value[0],i=r.value[1],e.multiplicity(n)<i)return!1;return!0},a.isSuperset=function(t,e){return a.isSubset(e,t)},t.exports=a},function(t,e){function r(t){Object.defineProperty(this,"_next",{writable:!1,enumerable:!1,value:t}),this.done=!1}r.prototype.next=function(){if(this.done)return{done:!0};var t=this._next();return t.done&&(this.done=!0),t},"undefined"!=typeof Symbol&&(r.prototype[Symbol.iterator]=function(){return this}),r.of=function(){var t=arguments,e=t.length,n=0;return new r((function(){return n>=e?{done:!0}:{done:!1,value:t[n++]}}))},r.empty=function(){var t=new r(null);return t.done=!0,t},r.is=function(t){return t instanceof r||"object"==typeof t&&null!==t&&"function"==typeof t.next},t.exports=r},function(t,e,r){var n=r(1),i=r(5),o=n.DEFAULT_COMPARATOR,s=n.reverseComparator;function a(t,e,r,n){for(var o,s=r,a=n,h=e[n],u=2*n+1;u<s;)(o=u+1)<s&&t(e[u],e[o])>=0&&(u=o),e[n]=e[u],u=2*(n=u)+1;e[n]=h,i.siftDown(t,e,a,n)}function h(t,e,r,n){for(var i,o,s=n,h=new t(n);s>0;)i=r[--s],0!==s&&(o=r[0],r[0]=i,a(e,r,--n,0),i=o),h[s]=i;return h}function u(t,e,r){if(2===arguments.length&&(r=e,e=null),this.ArrayClass=t,this.capacity=r,this.items=new t(r),this.clear(),this.comparator=e||o,"number"!=typeof r&&r<=0)throw new Error("mnemonist/FixedReverseHeap.constructor: capacity should be a number > 0.");if("function"!=typeof this.comparator)throw new Error("mnemonist/FixedReverseHeap.constructor: given comparator should be a function.");this.comparator=s(this.comparator)}u.prototype.clear=function(){this.size=0},u.prototype.push=function(t){return this.size<this.capacity?(this.items[this.size]=t,i.siftDown(this.comparator,this.items,0,this.size),this.size++):this.comparator(t,this.items[0])>0&&i.replace(this.comparator,this.items,t),this.size},u.prototype.peek=function(){return this.items[0]},u.prototype.consume=function(){var t=h(this.ArrayClass,this.comparator,this.items,this.size);return this.size=0,t},u.prototype.toArray=function(){return h(this.ArrayClass,this.comparator,this.items.slice(0,this.size),this.size)},u.prototype.inspect=function(){var t=this.toArray();return Object.defineProperty(t,"constructor",{value:u,enumerable:!1}),t},"undefined"!=typeof Symbol&&(u.prototype[Symbol.for("nodejs.util.inspect.custom")]=u.prototype.inspect),t.exports=u},function(t,e,r){var n=r(0),i=r(1),o=r(6),s=i.DEFAULT_COMPARATOR,a=i.reverseComparator;function h(t,e,r,n){for(var i,o,s=e[n];n>r&&t(s,o=e[i=n-1>>1])<0;)e[n]=o,n=i;e[n]=s}function u(t,e,r){for(var n,i=e.length,o=r,s=e[r],a=2*r+1;a<i;)(n=a+1)<i&&t(e[a],e[n])>=0&&(a=n),e[r]=e[a],a=2*(r=a)+1;e[r]=s,h(t,e,o,r)}function c(t,e,r){e.push(r),h(t,e,0,e.length-1)}function l(t,e){var r=e.pop();if(0!==e.length){var n=e[0];return e[0]=r,u(t,e,0),n}return r}function f(t,e,r){if(0===e.length)throw new Error("mnemonist/heap.replace: cannot pop an empty heap.");var n=e[0];return e[0]=r,u(t,e,0),n}function p(t,e,r){var n;return 0!==e.length&&t(e[0],r)<0&&(n=e[0],e[0]=r,r=n,u(t,e,0)),r}function m(t,e){for(var r=e.length>>1;--r>=0;)u(t,e,r)}function y(t,e){for(var r=e.length,n=0,i=new Array(r);n<r;)i[n++]=l(t,e);return i}function d(t){if(this.clear(),this.comparator=t||s,"function"!=typeof this.comparator)throw new Error("mnemonist/Heap.constructor: given comparator should be a function.")}function w(t){if(this.clear(),this.comparator=t||s,"function"!=typeof this.comparator)throw new Error("mnemonist/MaxHeap.constructor: given comparator should be a function.");this.comparator=a(this.comparator)}d.prototype.clear=function(){this.items=[],this.size=0},d.prototype.push=function(t){return c(this.comparator,this.items,t),++this.size},d.prototype.peek=function(){return this.items[0]},d.prototype.pop=function(){return 0!==this.size&&this.size--,l(this.comparator,this.items)},d.prototype.replace=function(t){return f(this.comparator,this.items,t)},d.prototype.pushpop=function(t){return p(this.comparator,this.items,t)},d.prototype.consume=function(){return this.size=0,y(this.comparator,this.items)},d.prototype.toArray=function(){return y(this.comparator,this.items.slice())},d.prototype.inspect=function(){var t=this.toArray();return Object.defineProperty(t,"constructor",{value:d,enumerable:!1}),t},"undefined"!=typeof Symbol&&(d.prototype[Symbol.for("nodejs.util.inspect.custom")]=d.prototype.inspect),w.prototype=d.prototype,d.from=function(t,e){var r,n=new d(e);return r=o.isArrayLike(t)?t.slice():o.toArray(t),m(n.comparator,r),n.items=r,n.size=r.length,n},w.from=function(t,e){var r,n=new w(e);return r=o.isArrayLike(t)?t.slice():o.toArray(t),m(n.comparator,r),n.items=r,n.size=r.length,n},d.siftUp=u,d.siftDown=h,d.push=c,d.pop=l,d.replace=f,d.pushpop=p,d.heapify=m,d.consume=y,d.nsmallest=function(t,e,r){2===arguments.length&&(r=e,e=t,t=s);var i,h,u,c,l=a(t),p=1/0;if(1===e){if(o.isArrayLike(r)){for(i=0,h=r.length;i<h;i++)u=r[i],(p===1/0||t(u,p)<0)&&(p=u);return(c=new r.constructor(1))[0]=p,c}return n(r,(function(e){(p===1/0||t(e,p)<0)&&(p=e)})),[p]}if(o.isArrayLike(r)){if(e>=r.length)return r.slice().sort(t);for(c=r.slice(0,e),m(l,c),i=e,h=r.length;i<h;i++)l(r[i],c[0])>0&&f(l,c,r[i]);return c.sort(t)}var y=o.guessLength(r);return null!==y&&y<e&&(e=y),c=new Array(e),i=0,n(r,(function(t){i<e?c[i]=t:(i===e&&m(l,c),l(t,c[0])>0&&f(l,c,t)),i++})),c.length>i&&(c.length=i),c.sort(t)},d.nlargest=function(t,e,r){2===arguments.length&&(r=e,e=t,t=s);var i,h,u,c,l=a(t),p=-1/0;if(1===e){if(o.isArrayLike(r)){for(i=0,h=r.length;i<h;i++)u=r[i],(p===-1/0||t(u,p)>0)&&(p=u);return(c=new r.constructor(1))[0]=p,c}return n(r,(function(e){(p===-1/0||t(e,p)>0)&&(p=e)})),[p]}if(o.isArrayLike(r)){if(e>=r.length)return r.slice().sort(l);for(c=r.slice(0,e),m(t,c),i=e,h=r.length;i<h;i++)t(r[i],c[0])>0&&f(t,c,r[i]);return c.sort(l)}var y=o.guessLength(r);return null!==y&&y<e&&(e=y),c=new Array(e),i=0,n(r,(function(r){i<e?c[i]=r:(i===e&&m(t,c),t(r,c[0])>0&&f(t,c,r)),i++})),c.length>i&&(c.length=i),c.sort(l)},d.MinHeap=d,d.MaxHeap=w,t.exports=d},function(t,e,r){var n=r(0),i=r(7).isTypedArray;function o(t){return"number"==typeof t.length?t.length:"number"==typeof t.size?t.size:void 0}e.isArrayLike=function(t){return Array.isArray(t)||i(t)},e.guessLength=o,e.toArray=function(t){var e=o(t),r="number"==typeof e?new Array(e):[],i=0;return n(t,(function(t){r[i++]=t})),r}},function(t,e){var r=Math.pow(2,8)-1,n=Math.pow(2,16)-1,i=Math.pow(2,32)-1,o=Math.pow(2,7)-1,s=Math.pow(2,15)-1,a=Math.pow(2,31)-1;e.getPointerArray=function(t){var e=t-1;return e<=r?Uint8Array:e<=n?Uint16Array:e<=i?Uint32Array:Float64Array},e.getSignedPointerArray=function(t){var e=t-1;return e<=o?Int8Array:e<=s?Int16Array:e<=a?Int32Array:Float64Array},e.getNumberType=function(t){return t===(0|t)?-1===Math.sign(t)?t<=127&&t>=-128?Int8Array:t<=32767&&t>=-32768?Int16Array:Int32Array:t<=255?Uint8Array:t<=65535?Uint16Array:Uint32Array:Float64Array};var h={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};e.getMinimalRepresentation=function(t,r){var n,i,o,s,a,u=null,c=0;for(s=0,a=t.length;s<a;s++)o=r?r(t[s]):t[s],i=e.getNumberType(o),(n=h[i.name])>c&&(c=n,u=i);return u},e.isTypedArray=function(t){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(t)},e.concat=function(){var t,e,r,n=0;for(t=0,r=arguments.length;t<r;t++)n+=arguments[t].length;var i=new arguments[0].constructor(n);for(t=0,e=0;t<r;t++)i.set(arguments[t],e),e+=arguments[t].length;return i},e.indices=function(t){for(var r=new(e.getPointerArray(t))(t),n=0;n<t;n++)r[n]=n;return r}},function(t,e,r){"use strict";r.r(e);var n=r(2),i=r.n(n);class o{constructor(t,e,r){if(t<=0)throw new RangeError("duration_sec ≤ 0");this.duration_sec=t,this.onframe_=e,this.onfinish_=r,this.start_=0}isPlaying(){return s.getInstance().isScheduled(this)}play(t=this.duration_sec){if(t<=0)throw new RangeError("duration_sec ≤ 0");this.duration_sec=t,this.start_=performance.now(),s.getInstance().schedule(this)}stop(){s.getInstance().unschedule(this),this.onfinish_&&this.onfinish_()}drawFrame(t){const e=(t-this.start_)/(1e3*this.duration_sec);let r=!0;try{this.onframe_(Math.min(Math.max(0,e),1))}finally{e>=1&&(this.onfinish_&&this.onfinish_(),r=!1)}return r}}class s{constructor(){this.animationFrameId_=null,this.playing_=new i.a}static getInstance(){return this.instance_||(this.instance_=new s),this.instance_}schedule(t){this.playing_.add(t),this.startAnimating_()}unschedule(t){this.playing_.delete(t)}isScheduled(t){return this.playing_.has(t)}animationFrame_(t){try{for(const e of Array.from(this.playing_))e.drawFrame.call(e,t)||this.playing_.remove(e)}catch(t){throw this.playing_.clear(),t}finally{this.animationFrameId_=null,this.playing_.size>0&&(this.animationFrameId_=window.requestAnimationFrame(this.animationFrame_.bind(this)))}}startAnimating_(){null===this.animationFrameId_&&(this.animationFrameId_=window.requestAnimationFrame(this.animationFrame_.bind(this)))}cancelAnimating_(){null!==this.animationFrameId_&&(window.cancelAnimationFrame(this.animationFrameId_),this.animationFrameId_=null)}}const a=2*Math.PI/12,h=456,u=456;var c;!function(t){t[t.NONE=0]="NONE",t[t.NORMAL=1]="NORMAL",t[t.UNDO=2]="UNDO"}(c||(c={}));function l(t){t.save(),t.clip(),t.fill(),t.stroke(),t.restore()}function f(t,e,r,n,i,o,s,a=!1){t.arc(e,r,n,o,s,a),t.arc(e,r,i,s,o,!a),t.closePath()}class p{constructor(t){this.fill_=t,this.hasEnemy=!1}drawBase(t,e){t.strokeStyle="black",t.fillStyle=this.fill_,t.lineWidth=.8,this.basePath(t,e),l(t)}drawTop(t,{th:e,r:r}){if(this.hasEnemy){t.fillStyle="#ee0";const n=function({th:t,r:e}){return{x:(60+32*(e+.5))*Math.cos((t+.5)*a),y:(60+32*(e+.5))*Math.sin((t+.5)*a)}}({th:e,r:r});t.moveTo(n.x,n.y),t.beginPath(),t.arc(n.x,n.y,9,0,2*Math.PI),t.fill()}}clearTop(t,e){t.save(),t.fillStyle="black",t.globalCompositeOperation="destination-out",this.basePath(t,e),t.fill(),t.restore()}basePath(t,{th:e,r:r}){t.moveTo(0,0),t.beginPath();const n=60+32*r,i=e*a;f(t,0,0,n,n+32,i,i+a)}}class m{constructor(t){this.canvases_=t;const e=t.ring.width,r=t.ring.height,n={};for(const i in t){const o=t[i];if(o.width!==e||o.height!==r)throw new RangeError("Uneven canvas size!");if(!o.getContext)throw new ReferenceError("No canvas context!");const s=o.getContext("2d");if(null===s)throw new ReferenceError("canvas.getContext null");s.translate(o.width/2,o.height/2),s.scale(o.width/h,o.height/u),n[i]=s}this.layers_=n,this.ringContents=[];for(let t=0;t<48;++t){const e=(t%2+Math.floor(t/12))%2==0?"#ada786":"#8f8a6d";this.ringContents.push(new p(e))}this.animation_=new o(.15,t=>{if(!this.currentMovement_)throw new ReferenceError("Last movement null?");m.isNegativeMovement(this.currentMovement_)&&(t=-t),this.drawGroup(this.currentMovement_,t)},()=>{if(!this.currentMovement_)throw new ReferenceError("Last movement null?");if(this.move(this.currentMovement_),--this.currentMovement_.amount>0)this.animation_.play();else for(this.currentMovement_=null;this.readyCallbacks_.length>0;){const t=this.readyCallbacks_.shift();if(!t)throw new ReferenceError("cb null???");if(t(),null!==this.currentMovement_)break}}),this.currentMovement_=null,this.readyCallbacks_=[]}static isNegativeMovement(t){return"ring"===t.type&&!t.clockwise||"row"===t.type&&!t.outward}isBusy(){return this.animation_.isPlaying()}async waitUntilReady(){return this.isBusy()?new Promise(t=>this.readyCallbacks_.push(t)):Promise.resolve()}async animateMove(t,e=c.NORMAL){await this.waitUntilReady(),e!==c.NONE?(this.currentMovement_={...t},this.animation_.play(function(t,e){switch(e){case c.NONE:return 0;case c.NORMAL:return"ring"===t?.15:.2;case c.UNDO:return"ring"===t?.05:.08}}(t.type,e)),await this.waitUntilReady()):this.move(t)}move(t){if(t.amount<1)throw new RangeError(`move amount ${t.amount} < 1`);"ring"===t.type?this.rotateRing(t.r,t.clockwise):this.shiftRow(t.th,t.outward)}rotateRing(t,e){console.log("Rotate ring",t,e?"clockwise":"anti-clockwise");let r=12*t,n=1,i=12*(t+1);const o=this.ringContents;e&&(n=-n,[r,i]=[i+n,r+n]);for(let t=r;t!==i-n;t+=n)[o[t],o[t+n]]=[o[t+n],o[t]]}shiftRow(t,e){if(console.log("Shift row",t,e?"outward":"inward"),t>=6)return void this.shiftRow(t-6,!e);let r=t,n=12,i=t+48;e&&(r+=n/2,i+=n/2);const o=this.ringContents;if((i-r)%n!=0)throw new RangeError("wtf");let s=r,a=0;for(;++a<8;){let t=s+n;Math.round(t)===i&&(t-=n/2,e&&(t-=n),n=-n),[o[s],o[t]]=[o[t],o[s]],s=t}}getCell({th:t,r:e}){if(t<0||t>=12||e<0||e>=4)throw new RangeError(`Cell index out of range: {th: ${t}, r: ${e}}}`);return this.ringContents[t%12+12*e]}draw(){this.drawRing(),this.drawBackground()}getLayer(t="ring"){const e=this.layers_[t];if(void 0===e)throw new ReferenceError(`No layer named ${t}!`);return e}drawGroup(t,e=0,r=!0){"ring"===t.type?this.drawSubring(t.r,e):(this.drawRow(t.th,e),r&&this.drawRow((t.th+6)%12,-e))}drawSubring(t,e=0){const r=this.getLayer(),n=this.getLayer("enemy");n.save(),n.fillStyle="black",n.globalCompositeOperation="destination-out",n.moveTo(0,0),n.beginPath();const i=60+32*t;f(n,0,0,i,i+32,0,2*Math.PI),n.fill(),n.restore();for(let i=0;i<12;++i){const o=this.getCell({th:i,r:t}),s=i+e;o.drawBase(r,{th:s,r:t}),o.drawTop(n,{th:s,r:t})}}drawRow(t,e=0){const r=this.getLayer(),n=this.getLayer("enemy");n.save(),n.fillStyle="black",n.globalCompositeOperation="destination-out",n.moveTo(0,0),n.beginPath();const i=t*a;f(n,0,0,60,188,i,i+a),n.fill(),n.restore(),n.save(),n.clip();try{for(let i=0;i<4;++i){const o=this.getCell({th:t,r:i}),s=i+e;o.drawBase(r,{th:t,r:s}),o.drawTop(n,{th:t,r:s})}if(0!==e){const i=(t+6)%12,o=e<0?3:0,s=(e<0?4:-1)+e,a=this.getCell({th:i,r:o});a.drawBase(r,{th:t,r:s}),a.drawTop(n,{th:t,r:s})}}finally{n.restore()}}drawRing(){for(let t=0;t<4;++t)this.drawSubring(t)}drawBackground(){const t=this.getLayer("overlay");t.fillStyle="#bf7e56",t.moveTo(0,0),t.beginPath(),t.arc(0,0,60,0,2*Math.PI),t.fill(),t.fillStyle="#a64250",t.moveTo(0,0),t.beginPath(),t.arc(0,0,54,0,2*Math.PI),t.fill(),t.lineWidth=6,t.fillStyle="#5AE67C",t.strokeStyle="#99851A",t.moveTo(0,0),t.beginPath();t.arc(0,0,228,0,2*Math.PI,!1),t.moveTo(0,0),t.arc(0,0,188,0,2*Math.PI,!0),l(t)}offsetToFramePos(t){const e=window.getComputedStyle(this.canvases_.ring),r=parseInt(e.width,10),n=parseInt(e.height,10);return{x:t.x/r*h-h/2,y:t.y/n*u-u/2}}offsetToRingPos(t){const{x:e,y:r}=this.offsetToFramePos(t),n=Math.floor(Math.atan2(-r,-e)/(2*Math.PI)*12+6),i=Math.floor((Math.sqrt(e*e+r*r)-60)/32);if(i<0||i>=4)return null;if(n<0||n>=12)throw new RangeError("Theta out of range??");return{th:n,r:i}}onMouseDown(t){const e=this.offsetToRingPos({x:t.offsetX,y:t.offsetY});if(!e)return;console.log("click",e);const r=this.getLayer("enemy"),n=this.getCell(e);n.hasEnemy=!n.hasEnemy,n.clearTop(r,e),n.drawTop(r,e)}}function y(t){if("ring"===t.type){if(t.amount<=0)return{...t,amount:-t.amount,clockwise:!t.clockwise};const e=t.amount%12;return e>6?{...t,amount:12-e,clockwise:!t.clockwise}:{...t,amount:e}}if(t.amount<=0)return{...t,amount:-t.amount,outward:!t.outward};const e=t.amount%8;return e>4?{...t,amount:8-e,outward:!t.outward}:{...t,amount:e}}function d(t){return"ring"===t.type?{...t,clockwise:!t.clockwise}:{...t,outward:!t.outward}}class w{constructor(t){this.ringMovesDisplay_=t,this.moves_=[]}addMovement(t){this.moves_.push(t),this.updateDisplay()}get empty(){return 0===this.moves_.length}popMovement(){const t=this.moves_.pop();if(void 0===t)throw Error("No movements to pop");return this.updateDisplay(),t}updateDisplay(){this.ringMovesDisplay_.innerText="×"+this.moves_.length}}var g;!function(t){t[t.UNFOCUSED=0]="UNFOCUSED",t[t.FOCUSED=1]="FOCUSED",t[t.HIDDEN=2]="HIDDEN"}(g||(g={}));class v{constructor(t,e,r){this.type="ring",this.pos={r:0,th:0},this.state_=g.UNFOCUSED,this.currentMovement_=null,this.animatingMovement_=null,this.ring_=t,this.animation_=new o(.05,t=>this.drawAnimationFrame(t),()=>{if(!this.animatingMovement_)throw new ReferenceError("Last movement undefined?");const t="ring"===this.animatingMovement_.type||this.animatingMovement_.clockwise;this.move(t,!1),this.draw()}),this.moveHistory_=e,this.controlsDisplay_=r}get hidden(){return this.state_===g.HIDDEN}get focused(){return this.state_===g.FOCUSED}switchType(){"ring"===this.type?this.type="row":"row"===this.type&&(this.type="ring")}sectionSelected(t,e){return this.type===t&&("ring"===this.type?e===this.pos.r:e===this.pos.th)}cellSelected({th:t,r:e}){return"ring"===this.type?e===this.pos.r:t===this.pos.th}move(t,e=!0){if(e){if(this.animation_.isPlaying())return;return this.animatingMovement_={clockwise:t,type:this.type},void this.animation_.play("ring"===this.type?.05:.1)}if("ring"===this.type)this.pos={...this.pos,r:(this.pos.r+1)%4};else{const e=t?1:-1;this.pos={...this.pos,th:(this.pos.th+e+12)%6}}}drawAnimationFrame(t){if(!this.animatingMovement_)throw new ReferenceError("Last movement null?");"row"===this.animatingMovement_.type&&this.animatingMovement_.clockwise&&(t=-t),this.draw(t)}draw(t=0,e=this.ring_.getLayer("cursor")){e.clearRect(-h/2,-u/2,1.5*h,1.5*u),this.hidden||(e.fillStyle=this.focused?"rgba(82, 148, 250, 0.8)":"rgba(186, 210, 247, 0.5)","ring"===this.type?this.drawRing_(t,e):"row"===this.type&&this.drawRow_(t,e))}drawRing_(t,e){let r=this.pos.r+t;e.moveTo(0,0),e.beginPath();const n=60+32*r;if(f(e,0,0,n,n+32,0,2*Math.PI),e.fill(),r>3||r<0){r=(r+4)%4;const t=60+32*r;e.moveTo(0,0),e.beginPath(),f(e,0,0,t,t+32,0,2*Math.PI),e.fill()}}drawRow_(t,e){const r=this.pos.th;e.moveTo(0,0),e.beginPath();for(const n of[r,(r+6)%12]){const r=(n-t)*a;f(e,0,0,60,188,r,r+a),e.moveTo(0,0)}e.fill()}hide(){if(!this.hidden){if(this.focused&&this.confirm(),this.state_!==g.UNFOCUSED)throw new Error("BUG: Cursor state not unfocused");this.state_=g.HIDDEN,this.draw(),this.updateControls()}}show(){this.hidden&&(this.state_=g.UNFOCUSED),this.draw(),this.updateControls()}onKeyDown(t){if(!this.ring_.isBusy()&&!this.hidden)if("Enter"!==t.key||this.focused)if(" "===t.key)this.focused?this.confirm():this.switchFocus();else if("Backspace"===t.key||"Escape"===t.key)this.focused?this.cancel():this.undo();else if(this.focused)this.moveRing(t.key);else{const e=this.arrowIsPositive(t.key);if(null===e)return;this.move(e),this.draw()}else this.currentMovement_=null,this.switchType(),this.draw()}confirm(){this.moveHistory_.addMovement(this.currentMovement_),this.switchFocus()}cancel(){if(null===this.currentMovement_)return void this.switchFocus();const t=d(this.currentMovement_);this.ring_.animateMove(t,c.UNDO).then(()=>this.switchFocus()),this.ring_.drawGroup(t),this.currentMovement_=null,this.updateControls()}undo(){if(this.moveHistory_.empty)return;const t=this.moveHistory_.popMovement();null!==t&&(this.ring_.animateMove(d(t),c.UNDO),this.ring_.drawGroup(t),this.updateControls())}switchFocus(){this.hidden||(this.state_=this.focused?g.UNFOCUSED:g.FOCUSED,this.currentMovement_=null,this.draw(),this.updateControls())}updateControls(){let t;this.focused?t="moving":(t="choosing",this.moveHistory_.empty||(t+=" undo")),this.controlsDisplay_.setAttribute("state",t),this.hidden?this.controlsDisplay_.classList.add("hidden"):this.controlsDisplay_.classList.remove("hidden")}moveRing(t){let e,r=this.arrowIsPositive(t);if(null!==r){if("ring"===this.type)e={type:"ring",clockwise:r,r:this.pos.r,amount:1};else{const n=this.pos.th;!(n%6>=3)||"ArrowLeft"!==t&&"ArrowRight"!==t||(r=!r),e={type:"row",outward:r,th:n,amount:1}}this.currentMovement_=function(t,e){if(null===t)return e;if("ring"===t.type&&"ring"===e.type){if(t.r!==e.r)return null;const r=(t.clockwise?t.amount:-t.amount)+(e.clockwise?e.amount:-e.amount);return 0===r?null:y({type:"ring",amount:Math.abs(r),clockwise:r>0,r:t.r})}if("row"===t.type&&"row"===e.type){if(t.th!==e.th)return null;const r=(t.outward?t.amount:-t.amount)+(e.outward?e.amount:-e.amount);return 0===r?null:y({type:"row",amount:Math.abs(r),outward:r>0,th:t.th})}return null}(this.currentMovement_,e),this.ring_.animateMove(e,c.NORMAL),this.ring_.drawGroup(e)}}arrowIsPositive(t){return"ArrowUp"!==t&&"ArrowLeft"!==t&&("ArrowDown"===t||"ArrowRight"===t||null)}}function _(t){const e=[0,0,0,0];for(let r=0;r<4;++r){let n=0;for(let e=0;e<12;++e)n|=(t.getCell({th:e,r:r}).hasEnemy?1:0)<<e;e[r]=n}return e}class b{constructor(){this.worker_=null}async getWorker(){if(null===this.worker_){const t=new Worker("./worker.js");t.onmessage=t.onerror=t.onmessageerror=console.error,this.worker_=t}return this.worker_}async solve(t){const e=await this.getWorker(),r=new MessageChannel;return e.postMessage({ondone:r.port2,ringData:_(t)},[r.port2]),new Promise((t,e)=>{r.port1.onmessage=r=>{if("done"===r.data.type){const e=r.data.solution;t(null===e?null:{...e,moves:e.moves.map(y)})}else e(r.data.error)},r.port1.onmessageerror=t=>{e(t.data)}})}}function A(t){const e=document.getElementById(t);if(!e)throw new Error("Could not find element with id "+t);return e}window.addEventListener("load",(function(){const t=A("overlay-layer"),e=new m({enemy:A("enemy-layer"),ring:A("ring-layer"),cursor:A("cursor-layer"),overlay:t}),r=new w(A("ring-moves")),n=new v(e,r,A("controls")),i=new b,o=A("solve-button");e.draw(),n.draw(),t.addEventListener("mousedown",t=>{o.classList.contains("solving")||(o.innerText="Solve",e.onMouseDown(t))}),document.addEventListener("keydown",n.onKeyDown.bind(n)),o.addEventListener("mousedown",t=>t.preventDefault()),o.addEventListener("click",async()=>{if(o.classList.contains("solving"))return;let t;o.classList.add("solving"),o.innerText="Solving";try{t=await i.solve(e)}catch(t){throw o.innerText="Error!",o.classList.add("error"),o.classList.remove("solving"),t}if(t){console.log(t),n.hide();for(const n of t.moves)await e.animateMove(n),r.addMovement(n),await new Promise(t=>setTimeout(t,250));n.show(),o.innerText="Solved!"}else o.innerText="Can't solve in 4 turns!";o.classList.remove("solving")})}))}]);
//# sourceMappingURL=index.js.map